[save_variables]
filename: ~/printer_data/config/saved_variables.cfg

[filament_switch_sensor filament_sensor]
pause_on_runout: True
switch_pin: ^!your_pin  # Replace with your pin
insert_gcode:
    M117 New Filament Detected
    RESPOND TYPE=command MSG="New filament detected! Please specify filament type..."
    UPDATE_DELAYED_GCODE ID=FILAMENT_INSERT_PROMPT DURATION=0.1
runout_gcode:
    M117 Filament Runout Detected
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0  # Prevent duplicate triggers
    SAVE_VARIABLE VARIABLE=current_filament_type VALUE='""'
    SAVE_VARIABLE VARIABLE=current_filament_temp VALUE=0
    PAUSE

[delayed_gcode FILAMENT_INSERT_PROMPT]
gcode:
    {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170) %}
    SET_IDLE_TIMEOUT TIMEOUT=43200  # Set timeout to 12 hours
    RESPOND TYPE=command MSG="Available Filament Types:"
    RESPOND TYPE=command MSG="1: PLA (210°C)"
    RESPOND TYPE=command MSG="2: PETG (230°C)"
    RESPOND TYPE=command MSG="3: ABS (245°C)"
    RESPOND TYPE=command MSG="4: TPU (220°C)"
    RESPOND TYPE=command MSG="Custom: LOAD_FILAMENT TYPE='Custom Name' TEMP=xxx"
    RESPOND TYPE=command MSG="Send command to load (e.g., LOAD_FILAMENT TYPE=PLA)"

[gcode_macro SET_FILAMENT_TYPE]
description: Set the current type of filament
gcode:
    {% set TYPE = params.TYPE|default("")|string %}
    {% set TEMP = params.TEMP|default(0)|float %}
    
    # Validate input
    {% if TYPE == "" %}
        RESPOND TYPE=error MSG="Filament type must be specified. Example: SET_FILAMENT_TYPE TYPE=PLA TEMP=210"
        return
    {% endif %}
    
    {% if TEMP == 0 %}
        RESPOND TYPE=error MSG="Temperature must be specified for filament type"
        return
    {% endif %}
    
    SAVE_VARIABLE VARIABLE=current_filament_type VALUE='"{TYPE}"'
    SAVE_VARIABLE VARIABLE=current_filament_temp VALUE={TEMP}
    RESPOND TYPE=echo MSG="Set filament type to {TYPE} (Temp: {TEMP}°C)"

[gcode_macro LOAD_FILAMENT]
description: Load specific type of filament
gcode:
    {% set TYPE = params.TYPE|default("")|string %}
    {% set TEMP = params.TEMP|default(0)|float %}
    
    # Validate input
    {% if TYPE == "" %}
        RESPOND TYPE=error MSG="Filament type must be specified. Example: LOAD_FILAMENT TYPE=PLA"
        return
    {% endif %}
    
    # Set default temperatures if not specified
    {% if TEMP == 0 %}
        {% if TYPE|lower == "pla" %}
            {% set TEMP = 210 %}
        {% elif TYPE|lower == "petg" %}
            {% set TEMP = 230 %}
        {% elif TYPE|lower == "abs" %}
            {% set TEMP = 245 %}
        {% elif TYPE|lower == "tpu" %}
            {% set TEMP = 220 %}
        {% else %}
            RESPOND TYPE=error MSG="No temperature specified for custom filament type. Please use LOAD_FILAMENT TYPE='name' TEMP=xxx"
            return
        {% endif %}
    {% endif %}
    
    SET_FILAMENT_TYPE TYPE="{TYPE}" TEMP={TEMP}
    RESPOND TYPE=command MSG="Loading {TYPE} at {TEMP}°C - Confirm with 'CONFIRM_FILAMENT_LOAD' or cancel with 'CANCEL_FILAMENT_LOAD'"

[gcode_macro CONFIRM_FILAMENT_LOAD]
description: Confirm and complete filament loading process
gcode:
    {% set TYPE = printer.save_variables.variables.current_filament_type|default("") %}
    {% set TEMP = printer.save_variables.variables.current_filament_temp|default(0) %}
    
    # Validate stored values
    {% if TYPE == "" %}
        RESPOND TYPE=error MSG="No filament type set! Please use LOAD_FILAMENT first"
        return
    {% endif %}
    
    {% if TEMP == 0 %}
        RESPOND TYPE=error MSG="No temperature set! Please use LOAD_FILAMENT first"
        return
    {% endif %}
    
    # Heat up if needed
    {% if printer.extruder.temperature < TEMP %}
        M117 Heating to {TEMP}°C for {TYPE}
        M109 S{TEMP}    # Wait for temperature
    {% endif %}
    
    M117 Loading {TYPE}
    G91                   # Relative positioning
    G1 E50 F300          # Load filament slowly
    G1 E100 F1200        # Load filament faster
    G90                   # Absolute positioning
    
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1  # Re-enable sensor
    SET_IDLE_TIMEOUT TIMEOUT=1800  # Reset timeout to default (30 minutes)
    M117 {TYPE} Loaded
    RESPOND TYPE=echo MSG="Successfully loaded {TYPE} filament"
    
    {% if printer.pause_resume.is_paused %}
        M117 Resuming Print
        RESUME
    {% endif %}

[gcode_macro CANCEL_FILAMENT_LOAD]
description: Cancel filament loading process
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1  # Re-enable sensor
    SET_IDLE_TIMEOUT TIMEOUT=1800  # Reset timeout to default (30 minutes)
    M117 Load Cancelled
    SAVE_VARIABLE VARIABLE=current_filament_type VALUE='""'
    SAVE_VARIABLE VARIABLE=current_filament_temp VALUE=0
    RESPOND TYPE=error MSG="Filament load cancelled"