[include shell_command.cfg]

[include fluidd.cfg]

[include timelapse.cfg]

[include macro.cfg]

[include KAMP_Settings.cfg]

[include stealthburner_leds.cfg]

#[include eddy.cfg]

[include filament.cfg]

[pause_resume]

[exclude_object]

[include moonraker_obico_macros.cfg]

[mcu]      
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_32FFD505334E563619741751-if00
#serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_34FFD805334B433034781551-if00
#serial: /dev/serial/by-id/usb-katapult_stm32f103xe_34FFD805334B433034781551-if00 
restart_method: command     

[mcu extra_mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_55FF70064849825348142267-if00
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_52FF71064885875208231467-if00
#serial: /dev/serial/by-id/usb-katapult_stm32f103xe_52FF71064885875208231467-if00
restart_method: command      

[mcu expander]
serial: /dev/serial/by-id/usb-Klipper_stm32f042x6_030016001943304846333520-if00
restart_method: command

[mcu pico]
serial: /dev/serial/by-id/usb-Klipper_rp2040_E6635C08CB096C2C-if00
restart_method: command

[temperature_sensor mcu_temp]         
sensor_type: temperature_mcu
min_temp:0
max_temp:100

[temperature_sensor Host_temp]     
sensor_type: temperature_host
min_temp: 0
max_temp: 110

#[temperature_sensor Toolhead_Temp]
#sensor_type: temperature_mcu
#sensor_mcu: extra_mcu
#min_temp:0
#max_temp:100

[adxl345]
cs_pin:extra_mcu:PB12

[resonance_tester]
accel_chip: adxl345
probe_points:
    175, 175, 30  # an example175 Y175 Z30
#accel_per_hz:50
min_freq:1
#max_freq:100
#max_smoothing:0.2
#hz_per_sec:0.5

[input_shaper]
#damping_ratio_x: 0.001
#damping_ratio_y: 0.001
shaper_type_x = mzv
shaper_freq_x = 68.8
shaper_type_y = mzv
shaper_freq_y = 45.2

[printer]
kinematics: corexy           
max_velocity: 700            
max_accel: 20000             
#max_accel_to_decel: 10000 # deprecated
minimum_cruise_ratio: 0.5
max_z_velocity: 20           
max_z_accel: 1000             
square_corner_velocity: 5.0 

[stepper_x]
step_pin: PE2
dir_pin: !PE0
enable_pin: !PE3
rotation_distance: 40         
microsteps: 16                
full_steps_per_rotation:200   
endstop_pin: tmc2209_stepper_x: virtual_endstop              
position_min: 0               
position_endstop: 355         
position_max: 355             
homing_speed: 30              
homing_retract_dist: 0        
homing_positive_dir: True     
#--------------------------------------------------------------------
[tmc2209 stepper_x]
uart_pin: PE1
interpolate: True             
run_current: 1.1              
#hold_current: 1.2             
sense_resistor: 0.150         
stealthchop_threshold: 0      
uart_address:3
driver_sgthrs: 75 #70
diag_pin: PE15

[stepper_y]
step_pin: PB8
dir_pin: !PB6
enable_pin: !PB9
rotation_distance: 40         
microsteps: 16                
full_steps_per_rotation:200   
endstop_pin: tmc2209_stepper_y: virtual_endstop              
position_min: 0               
position_endstop: 364         
position_max: 364            
homing_speed: 30              
homing_retract_dist: 0        
homing_positive_dir: true     
#--------------------------------------------------------------------
[tmc2209 stepper_y]
uart_pin: PB7
interpolate: True             
run_current: 1.1              
#hold_current: 1.2             
sense_resistor: 0.150         
stealthchop_threshold: 0      
uart_address:3
driver_sgthrs: 85 #70
diag_pin: PE13 

[stepper_z] #motherboard：Z3 
step_pin:PC0    
dir_pin:PE5    
enable_pin:!PC1    
rotation_distance: 40         
gear_ratio: 80:12             
microsteps: 16                
endstop_pin: probe:z_virtual_endstop           
position_max: 347             
position_min: -5              
#position_endstop: 0
homing_speed: 15.0
homing_retract_dist: 5.0
homing_retract_speed: 15.0
second_homing_speed: 10.0

[tmc2209 stepper_z]
uart_pin: PE6 
interpolate: True             
run_current: 0.50           
#hold_current: 0.58         
sense_resistor: 0.150         
stealthchop_threshold: 999999 
uart_address:3

[stepper_z1] ##motherboard：Z1
step_pin:PD3  
dir_pin:!PD1 
enable_pin:!PD4 
rotation_distance: 40         
gear_ratio: 80:12            
microsteps: 16               

[tmc2209 stepper_z1]
uart_pin:PD2  
interpolate: True             
run_current:  0.50          
#hold_current: 0.58           
sense_resistor: 0.150         
stealthchop_threshold: 999999 
uart_address:3

[stepper_z2] ##motherboard：Z2
step_pin:PD7
dir_pin:PD5   
enable_pin:!PB5
rotation_distance: 40         
gear_ratio: 80:12             
microsteps: 16                

[tmc2209 stepper_z2]
uart_pin:PD6  
interpolate: True             
run_current: 0.50            
#hold_current: 0.58           
sense_resistor: 0.150         
stealthchop_threshold: 999999 
uart_address:3

[stepper_z3] ##motherboard：Z4
step_pin:PD11 
dir_pin:!PD9 
enable_pin:!PD12   
rotation_distance: 40         
gear_ratio: 80:12             
microsteps: 16                

[tmc2209 stepper_z3]
uart_pin:PD10    
interpolate: True            
run_current: 0.50         
#hold_current: 0.58           
sense_resistor: 0.150         
uart_address:3
stealthchop_threshold: 999999 

[thermistor my_thermistor_e]
temperature1:25
resistance1:110000
temperature2:100
resistance2:7008
temperature3:220
resistance3:435

[extruder]
step_pin: extra_mcu:PA8   
dir_pin: extra_mcu:PB8    
enable_pin:!extra_mcu: PB11   
rotation_distance: 6.5 
microsteps: 16                
full_steps_per_rotation: 200 
nozzle_diameter: 0.400        
filament_diameter: 1.75  
max_extrude_only_distance: 150     
heater_pin:extra_mcu:PB9  
sensor_type:my_thermistor_e
#sensor_type: Generic 3950
pullup_resistor: 11500
sensor_pin: extra_mcu:PA5  
min_temp: 5                  
max_temp: 305                 
max_power: 1.0                
min_extrude_temp: 150         
#control : pid
#pid_kp : 33.838
#pid_ki : 5.223
#pid_kd : 47.752
pressure_advance: 0.025       
pressure_advance_smooth_time: 0.04
max_extrude_cross_section: 10

[tmc2209 extruder]
uart_pin: extra_mcu:PB10  
interpolate: True             
run_current: 0.8           
#hold_current: 0.75             
uart_address:3
sense_resistor: 0.150          

[verify_heater extruder]      
max_error: 120                
check_gain_time:30           
hysteresis: 5                
heating_gain: 2               

[filament_switch_sensor filament_sensor]
pause_on_runout: True
event_delay: 3.0
pause_delay: 0.5
switch_pin: PE9

[thermistor my_thermistor]
temperature1:25
resistance1:100000
temperature2:50
resistance2:18085.4
temperature3:100
resistance3:5362.6

[heater_bed]
heater_pin:PA0
sensor_type: my_thermistor  
sensor_pin: PC5
max_power: 1.0               
min_temp: 5                  
max_temp: 105                
#control : pid
#pid_kp : 73.571
#pid_ki : 1.820
#pid_kd : 783.849

[verify_heater heater_bed]      
max_error: 120                
check_gain_time:40           
hysteresis: 5                
heating_gain: 2 

#[probe]
#pin: extra_mcu:PB6    
#x_offset: -17                  
#y_offset: 10             
#z_offset : 0
#speed: 15.0
#speed: 5.0
#samples: 2
#sample_retract_dist: 2.0
#lift_speed: 50
#samples_result: average
#samples_tolerance: 0.016
#samples_tolerance_retries: 2

#[probe_pressure]
#pin: ^!PE12     
#x_offset: 0                  
#y_offset: 0
#z_offset : 0
#speed: 1.0

#[z_offset_calibration]
#center_xy_position:191,165      
#endstop_xy_position:289,361                         
#z_hop: 10                       
#z_hop_speed: 15 

[quad_gantry_level]          
gantry_corners:              
	-60,-10
	410,420
points:
	36,10
	36,320
	346,320
	346,10
speed: 400                   
horizontal_move_z: 5      #Origina setting - horizontal_move_z: 10    
retry_tolerance: 0.008      #Origina setting - retry_tolerance: 0.05
retries: 10                  
max_adjust: 10              #Origina setting - max_adjust: 30  

#[bed_mesh]
#speed: 500                   
#horizontal_move_z: 5         
#mesh_min: 10,10              
#mesh_max: 320,320            
#probe_count: 10,10             
#algorithm: bicubic   
#bicubic_tension: 0.4
#split_delta_z: 0.016
#mesh_pps:3,3
#adaptive_margin: 5
#fade_start: 0
#fade_end: 10
#fade_target: 0           

[multi_pin print_cooling_fan_pins]
pins: extra_mcu:PA7, extra_mcu:PB1

[multi_pin chamber_fan_pins]
pins: expander:PA0, expander:PA1, expander:PA2

# print/part cooling fan
[fan]
pin: multi_pin:print_cooling_fan_pins
max_power: 1.0

[temperature_fan chamber] # chassis exhaust fan
pin: multi_pin:chamber_fan_pins
max_power: 1.0
shutdown_speed: 0.0
#kick_start_time: 5.0
#cycle_time:0.01
#off_below:0.1
sensor_type: BME280
min_temp: 0
max_temp: 70
max_delta: 1
target_temp: 30
control : watermark
i2c_address: 119
#   Default is 118 (0x76). The BMP180, BMP388 and some BME280 sensors
#   have an address of 119 (0x77).
i2c_mcu: pico
#   The name of the micro-controller that the chip is connected to.
#   The default is "mcu".
i2c_bus: i2c0a
#   If the micro-controller supports multiple I2C busses then one may
#   specify the micro-controller bus name here. The default depends on
#   the type of micro-controller.
#i2c_software_scl_pin:
#i2c_software_sda_pin:
#   Specify these parameters to use micro-controller software based
#   I2C "bit-banging" support. The two parameters should the two pins
#   on the micro-controller to use for the scl and sda wires. The
#   default is to use hardware based I2C support as specified by the
#   i2c_bus parameter.
#i2c_speed:
#   The I2C speed (in Hz) to use when communicating with the device.
#   The Klipper implementation on most micro-controllers is hard-coded
#   to 100000 and changing this value has no effect. The default is
#   100000. Linux, RP2040 and ATmega support 400000.
gcode_id:

[heater_fan hotend_fan]      
pin: extra_mcu:PA6   
max_power: 1.0               
kick_start_time: 0.5         
heater: extruder             
heater_temp: 50              
tachometer_pin:extra_mcu:PA1
tachometer_ppr: 1
tachometer_poll_interval: 0.0013

[temperature_fan toolhead_fan]
pin: extra_mcu:PB0 
max_power: 1.0
shutdown_speed: 1.0
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.
sensor_type: temperature_mcu
sensor_mcu: extra_mcu
control: watermark
max_delta: 3.0
min_temp: 0
max_temp: 100
#   See the "extruder" section for a description of the above parameters.
#pid_Kp:
#pid_Ki:
#pid_Kd:
#   The proportional (pid_Kp), integral (pid_Ki), and derivative
#   (pid_Kd) settings for the PID feedback control system. Klipper
#   evaluates the PID settings with the following general formula:
#     fan_pwm = max_power - (Kp*e + Ki*integral(e) - Kd*derivative(e)) / 255
#   Where "e" is "target_temperature - measured_temperature" and
#   "fan_pwm" is the requested fan rate with 0.0 being full off and
#   1.0 being full on. The pid_Kp, pid_Ki, and pid_Kd parameters must
#   be provided when the PID control algorithm is enabled.
#pid_deriv_time: 2.0
#   A time value (in seconds) over which temperature measurements will
#   be smoothed when using the PID control algorithm. This may reduce
#   the impact of measurement noise. The default is 2 seconds.
#target_temp: 40.0
#   A temperature (in Celsius) that will be the target temperature.
#   The default is 40 degrees.
#max_speed: 1.0
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when the sensor temperature exceeds the set value.
#   The default is 1.0.
#min_speed: 0.3
#   The minimum fan speed (expressed as a value from 0.0 to 1.0) that
#   the fan will be set to for PID temperature fans.
#   The default is 0.3.
#gcode_id:
#   If set, the temperature will be reported in M105 queries using the
#   given id. The default is to not report the temperature via M105.


[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PA8,   EXP1_2=PC9,
    EXP1_3=PA10,  EXP1_4=PA9,
    EXP1_5=PC11,  EXP1_6=PC10,
    EXP1_7=PD8,   EXP1_8=PC12,
    EXP1_9=<GND>, EXP1_10=<5V>,
 
    # EXP2 header
    EXP2_1=PB14,  EXP2_2=PB13,
    EXP2_3=PC7,   EXP2_4=PB12,
    EXP2_5=PC6,   EXP2_6=PB15,
    EXP2_7=PC8,   EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>
 
[display]                    
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2
 
[output_pin beeper]
pin: EXP1_1
pwm: False
value: 0
 
[neopixel Screen_Color]     
pin: EXP1_6
chain_count: 3
color_order: RGB             
initial_RED: 1.0             
initial_GREEN: 0.0           
initial_BLUE: 0.0          

[gcode_arcs]                       
resolution: 1.0             

[output_pin main_led]
pin:PA3
pwm: 1
value:1
cycle_time: 0.010

[idle_timeout]
gcode: 
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 1000
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

#[homing_override]
#gcode:
#   {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
#     G28.1 X
#     G0 X191 F3600
#   {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
#     G28.1 Y
#     G0 Y165  F3600
#   {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
#     G28.1 Y
#     G0 Y165  F3600
#     G4 P2000
#     G28.1 X
#     G0 X191  F3600
#   {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
#     G90
#     G0 X191 Y165 F3600
#     G28.1 Z
#     G0  Z10 F600
#   {% else %}
#     G90
#     G0 Z5 F300
#     G28.1 Y
#     G0 Y165  F3600
#     G4 P2000
#     G28.1 X
#     G0 X191  F3600
#     G90
#     G0  X191 Y165 F3600
#     G28.1 Z
#     G0  Z10 F600
#   {% endif %}
#axes: xyz
#set_position_z: 0

[shaketune]
 result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
 number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
 keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
 show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
 timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.

[firmware_retraction]
retract_length: 0.6
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 60
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 10
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

#[neopixel toolhead]
#pin: extra_mcu:PA10
#   The pin connected to the neopixel. This parameter must be provided.
#chain_count: 1
#   The number of Neopixel chips that are "daisy chained" to the
#   provided pin. The default is 1 (which indicates only a single
#   Neopixel is connected to the pin).
#color_order: GRB
#   Set the pixel order required by the LED hardware (using a string
#   containing the letters R, G, B, W with W optional). Alternatively,
#   this may be a comma separated list of pixel orders - one for each
#   LED in the chain. The default is GRB.
#initial_RED: 1.0
#initial_GREEN: 1.0
#initial_BLUE: 1.0
#initial_WHITE: 0.0
#   See the "led" section for information on these parameters.

#################################################################
#############-----Klipper Expander Board Pinout-----#############
#################################################################

# Other Pins
# GPIO = PA7

[static_digital_output onboardLED]
pins: !PA4

#[display]
#lcd_type: sh1106
#i2c_bus: i2c1a

#[output_pin mosfet0]
#pin: expander:PA0    #PA0, PA1, PA2, PA3 are all the options available
#value: 1
#shutdown_value: 0

#[output_pin mosfet1]
#pin: PA1
#value: 0
#shutdown_value: 0

#[output_pin mosfet2]
#pin: PA2
#value: 1
#shutdown_value: 0

#[output_pin mosfet3]
#pin: PA3
#value: 0
#shutdown_value: 0

#[temperature_sensor t0]
#sensor_type: ThermistorType
#sensor_pin: expander:PA6
#gcode_id: T0

#[temperature_sensor t1]
#sensor_type: ThermistorType
#sensor_pin: expander:PA5
#gcode_id: T1

#[neopixel Pixel]
#pin: expander:PB1
#chain_count: 1
#initial_RED: 0.9
#initial_GREEN: 0.3
#initial_BLUE: 0.0

#################################################################
#############----------BigTreeTech Eddy-------------#############
#################################################################

[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_45474E621A8575FA-if00
restart_method: command

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu # Sets the type of sensor for Klipper to read
sensor_mcu: eddy # Sets the MCU of the eddy probe tempereature sensor
min_temp: 10 # Sets the minimum tempereature for eddys tempereature sensor to operate
max_temp: 100 # Sets the maximum tempereature for eddys tempereature sensor to operate

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
#z_offset: 1.0
#i2c_address:
i2c_mcu: eddy  # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the MCU you have used.
i2c_bus: i2c0f # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the I2C bus you have used.
# Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
# For a standard Voron stealthburner X carriage mount there should be no need to change the defaults below.
x_offset: -16.0
y_offset: 12.0
#data_rate: 500

# This section is only relevant for Eddy USB. Comment it out for Eddy Coil.
[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2

[bed_mesh]
horizontal_move_z: 2
speed: 300
# For the mesh dimensions below, the coordinates need to be reachable by the center of the probe. To calculate coordinates that will work, use the formula below:
# mesh x min = position_min_x + greater_of (15mm or x_offset) <--- in this term, only consider the x offset if it is positive, ignore if negative.
# mesh y min = position_min_y + greater_of (15mm or y_offset) <--- in this term, only consider the y offset if it is positive, ignore if negative.
# mesh x max = position_max_x - greater_of (15mm or |x_offset|) <--- in this term, only consider the x offset if it is negative, ignore if positive.
# mesh y max = position_max_y - greater_of (15mm or |y_offset|) <--- in this term, only consider the y offset if it is negative, ignore if positive.
# Example: Consider that you have a 300 x 300 bed with the max x and y positions being 300 and the min being 0. Your probe offsets are -20 for X and 10 for Y
# For mesh x min we ignore the x offset term because it is negative. Therefore mesh x min = 15
# For mesh y min we do not ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y min = 15
# For mesh x max we do not ignore the x offset term because it is negative. It is also greater than 15. Therefore mesh x max = 280
# For mesh y max we ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y max = 285
# The final result would be mesh_min: 15, 15 mesh_max: 280, 285
mesh_min: 15, 15  # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
mesh_max: 330, 335 # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
probe_count: 25, 25
algorithm: bicubic
scan_overshoot: 8  #uncomment this section if you still have room left over on the X axis for some scan overshoot to product smoother movements and more accurate scanning. Uncommenting this should be fine if you are using a standard voron mount.

# Uncomment this if you are using Eddy as the probe AND the homing endstop
[safe_z_home]
home_xy_position: 177.5, 177.5 # Choose an X,Y position that is in the center of your bed. For a 300x300 machine that will be 150, 150. Use the same principle to calculate your bed center.
z_hop: 10
z_hop_speed: 25
speed: 200

###############################Macros and related################################
#This secton contains macros and related config sections. Some should be used, others are optional. Read the comment above each one to find out whether or not to uncomment it for your installation.


# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[save_variables]
filename: ~/printer_data/config/variables.cfg



# Uncomment this if you are using Eddy as the probe AND the homing endstop
[force_move]
enable_force_move: True # Allows a user to move the z axis down if they have no other means of homing Z and need to calibrate the Eddy.



# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[delayed_gcode RESTORE_PROBE_OFFSET]
initial_duration: 1.
gcode:
  {% set svv = printer.save_variables.variables %}
  {% if not printer["gcode_macro SET_GCODE_OFFSET"].restored %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ svv.nvm_offset|default(0) }
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=restored VALUE=True
  {% endif %}



# Uncomment this if you are using Eddy as the probe AND the homing endstop
# Take note of the lines that should only be used if you have a KNOMI installed.
[gcode_macro G28]
rename_existing: G28.1
gcode:
  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=True # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg
  G28.1 {rawparams}
  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
    PROBE
    SET_Z_FROM_PROBE
  {% endif %}
  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg



# Uncomment this if you are using Eddy as the probe AND the homing endstop
[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}



# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro Z_OFFSET_APPLY_PROBE]
rename_existing: Z_OFFSET_APPLY_PROBE_ORIG
gcode:
  SAVE_VARIABLE VARIABLE=nvm_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset }



# Uncomment the lines in this macro if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False  # Mark whether the var has been restored from NVM
variable_runtime_offset: 0
gcode:
  {% if params.Z_ADJUST %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
  {% endif %}
  {% if params.Z %}
    {% set paramList = rawparams.split() %}
    {% for i in range(paramList|length) %}
      {% if paramList[i]=="Z=0" %}
        {% set temp=paramList.pop(i) %}
        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
        {% if paramList.append(temp) %}{% endif %}
      {% endif %}
    {% endfor %}
    {% set rawparams=paramList|join(' ') %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
  {% endif %}
  SET_GCODE_OFFSET_ORIG { rawparams }



# This macro automates a lot of the frequency mapping process and simplifies the steps significantly.
[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
  {% endif %}
  PROBE_EDDY_CURRENT_CALIBRATE {rawparams}



#This macro is optional but useful if you want to run a rapid scan before each print. Simply uncomment it and add BED_MESH_SCAN to your print start code.
#[gcode_macro BED_MESH_CALIBRATE]
#rename_existing: BTT_BED_MESH_CALIBRATE
#gcode:
#  SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=True #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg
#  BTT_BED_MESH_CALIBRATE SCAN_MODE=rapid METHOD=scan
#  SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 69.421
#*# pid_ki = 1.268
#*# pid_kd = 950.200
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.649
#*# pid_ki = 3.490
#*# pid_kd = 47.129
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 17
#*# calibrate =
#*# 	0.050625:3287893.887,0.090000:3286759.265,0.129375:3285721.899,
#*# 	0.170625:3284548.198,0.210000:3283557.737,0.249375:3282491.393,
#*# 	0.290625:3281423.952,0.330000:3280397.329,0.369375:3279417.818,
#*# 	0.410625:3278407.611,0.450000:3277413.187,0.489375:3276488.502,
#*# 	0.530625:3275467.234,0.570000:3274563.605,0.609375:3273631.355,
#*# 	0.650625:3272725.931,0.690000:3271826.996,0.729375:3270947.748,
#*# 	0.770625:3270090.204,0.810000:3269253.615,0.849375:3268431.937,
#*# 	0.890625:3267613.256,0.930000:3266818.805,0.969375:3266044.680,
#*# 	1.010625:3265279.517,1.050000:3264483.334,1.089375:3263764.797,
#*# 	1.130625:3263004.525,1.170000:3262247.851,1.209375:3261555.029,
#*# 	1.250625:3260888.562,1.290000:3260164.995,1.329375:3259509.131,
#*# 	1.370625:3258808.445,1.410000:3258195.620,1.449375:3257554.373,
#*# 	1.490625:3256942.442,1.530000:3256322.424,1.569375:3255688.913,
#*# 	1.610625:3255109.339,1.650000:3254516.521,1.689375:3253962.673,
#*# 	1.730625:3253378.324,1.770000:3252827.954,1.809375:3252306.880,
#*# 	1.850625:3251754.949,1.890000:3251222.489,1.929375:3250707.044,
#*# 	1.970625:3250173.045,2.010000:3249690.736,2.049375:3249213.188,
#*# 	2.090625:3248717.925,2.130000:3248240.277,2.169375:3247788.860,
#*# 	2.210625:3247296.996,2.250000:3246863.557,2.289375:3246472.862,
#*# 	2.330625:3246008.814,2.370000:3245612.494,2.409375:3245195.317,
#*# 	2.450625:3244795.103,2.490000:3244386.422,2.529375:3243987.603,
#*# 	2.570625:3243604.682,2.610000:3243221.357,2.649375:3242849.717,
#*# 	2.690625:3242470.023,2.730000:3242123.836,2.769375:3241773.395,
#*# 	2.810625:3241437.995,2.850000:3241108.042,2.889375:3240779.122,
#*# 	2.930625:3240432.665,2.970000:3240106.478,3.009375:3239817.428,
#*# 	3.050625:3239457.236,3.090000:3239178.879,3.129375:3238894.413,
#*# 	3.170625:3238567.458,3.210000:3238299.541,3.249375:3238005.960,
#*# 	3.290625:3237744.384,3.330000:3237444.758,3.369375:3237163.002,
#*# 	3.410625:3236915.424,3.450000:3236653.903,3.489375:3236437.973,
#*# 	3.530625:3236146.243,3.570000:3235896.063,3.609375:3235634.942,
#*# 	3.650625:3235399.173,3.690000:3235174.555,3.729375:3234932.543,
#*# 	3.770625:3234685.125,3.810000:3234479.655,3.849375:3234249.498,
#*# 	3.890625:3234028.664,3.930000:3233823.206,3.969375:3233598.866,
#*# 	4.010625:3233383.448,4.050000:3233171.309
#*# z_offset = 1.274
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 39.280763
#*# drift_calibration =
#*# 	3231810.839096, 2133.627057, -16.617944
#*# 	3225055.075102, 1906.806955, -14.890780
#*# 	3220277.011318, 1675.635179, -13.001525
#*# 	3218014.540421, 1433.280346, -11.068987
#*# 	3216790.708134, 1217.498491, -9.362716
#*# 	3216422.456524, 1026.207969, -7.868248
#*# 	3215980.803630, 880.650679, -6.750350
#*# 	3215428.539558, 769.665817, -5.896728
#*# 	3214928.999082, 681.981145, -5.220220
#*# drift_calibration_min_temp = 39.21908250659306
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.146728, -0.193377, -0.265490, -0.355448, -0.382571, -0.388935, -0.385076, -0.391695, -0.390176, -0.394055, -0.390854, -0.390415, -0.383523, -0.365006, -0.359786, -0.358535, -0.349047, -0.333720, -0.319389, -0.295292, -0.269954, -0.249073, -0.211698, -0.169698, -0.142321
#*# 	  -0.257592, -0.308568, -0.394892, -0.432175, -0.437093, -0.442754, -0.436490, -0.425044, -0.441429, -0.440465, -0.433115, -0.434246, -0.426866, -0.400399, -0.404374, -0.398526, -0.381042, -0.374367, -0.352284, -0.318353, -0.299833, -0.270529, -0.233465, -0.208017, -0.195502
#*# 	  -0.295754, -0.358314, -0.410581, -0.408194, -0.402789, -0.405324, -0.399809, -0.407092, -0.405084, -0.409057, -0.404755, -0.408394, -0.406163, -0.395385, -0.384026, -0.377105, -0.362032, -0.345445, -0.323997, -0.299606, -0.270387, -0.239935, -0.220941, -0.191104, -0.183125
#*# 	  -0.326677, -0.384513, -0.406372, -0.409794, -0.403062, -0.406317, -0.408246, -0.412563, -0.416659, -0.411624, -0.412018, -0.405539, -0.413701, -0.387731, -0.394733, -0.391424, -0.375525, -0.356916, -0.330284, -0.304026, -0.283453, -0.266244, -0.232714, -0.207258, -0.191403
#*# 	  -0.373617, -0.405615, -0.422316, -0.424997, -0.424730, -0.426781, -0.427053, -0.427142, -0.425213, -0.430518, -0.421967, -0.416931, -0.406169, -0.406610, -0.413376, -0.410056, -0.396561, -0.379559, -0.355931, -0.329135, -0.303562, -0.293475, -0.261649, -0.245271, -0.224829
#*# 	  -0.345382, -0.399002, -0.418665, -0.413305, -0.417036, -0.430765, -0.425617, -0.412706, -0.424513, -0.429449, -0.411563, -0.412708, -0.414875, -0.401503, -0.400179, -0.395104, -0.379979, -0.373245, -0.348243, -0.329016, -0.302063, -0.284265, -0.260961, -0.232029, -0.218674
#*# 	  -0.333707, -0.382392, -0.393744, -0.397384, -0.399256, -0.412930, -0.408834, -0.405087, -0.402111, -0.408778, -0.409164, -0.414375, -0.404732, -0.395446, -0.399991, -0.396245, -0.381700, -0.362315, -0.355152, -0.337984, -0.312448, -0.289428, -0.265077, -0.232391, -0.219462
#*# 	  -0.351997, -0.419337, -0.448119, -0.448903, -0.444505, -0.453598, -0.451347, -0.440234, -0.446071, -0.462936, -0.449564, -0.444928, -0.445110, -0.430077, -0.430197, -0.422103, -0.422853, -0.409740, -0.391333, -0.370477, -0.351832, -0.335440, -0.311842, -0.280152, -0.265248
#*# 	  -0.322476, -0.382310, -0.391239, -0.392342, -0.394190, -0.397344, -0.408367, -0.407596, -0.409893, -0.407925, -0.402524, -0.414820, -0.400586, -0.389147, -0.389808, -0.391019, -0.379002, -0.362051, -0.340800, -0.321279, -0.303803, -0.291260, -0.266742, -0.247815, -0.228184
#*# 	  -0.277646, -0.356171, -0.363588, -0.360572, -0.354779, -0.352804, -0.372591, -0.371819, -0.371655, -0.381621, -0.368994, -0.367721, -0.362941, -0.355563, -0.351734, -0.348142, -0.335821, -0.319156, -0.308992, -0.285431, -0.265860, -0.245482, -0.225209, -0.213111, -0.200657
#*# 	  -0.278327, -0.335335, -0.343344, -0.335223, -0.340213, -0.350417, -0.350877, -0.354690, -0.370087, -0.357123, -0.355729, -0.364200, -0.354078, -0.333496, -0.333147, -0.325439, -0.305845, -0.303642, -0.286658, -0.262771, -0.244280, -0.230979, -0.212719, -0.212719, -0.186137
#*# 	  -0.273210, -0.331664, -0.345602, -0.337472, -0.332259, -0.339195, -0.343493, -0.345354, -0.347762, -0.353335, -0.342219, -0.331365, -0.346230, -0.335343, -0.322598, -0.309610, -0.299116, -0.288350, -0.276066, -0.246351, -0.226062, -0.211205, -0.201385, -0.191277, -0.171684
#*# 	  -0.269706, -0.328432, -0.334047, -0.330667, -0.327395, -0.337879, -0.330742, -0.332453, -0.333152, -0.334200, -0.333039, -0.338140, -0.338605, -0.324831, -0.307904, -0.302539, -0.283835, -0.281838, -0.272775, -0.245729, -0.213415, -0.204798, -0.186666, -0.175320, -0.150082
#*# 	  -0.303855, -0.366906, -0.374930, -0.370007, -0.362236, -0.375206, -0.376309, -0.378181, -0.369660, -0.383031, -0.386092, -0.382347, -0.391380, -0.373534, -0.359088, -0.352942, -0.334433, -0.327433, -0.319107, -0.279083, -0.264742, -0.254154, -0.221737, -0.203882, -0.190286
#*# 	  -0.255021, -0.314777, -0.320154, -0.315617, -0.314579, -0.328509, -0.332567, -0.340019, -0.340019, -0.344310, -0.349865, -0.350994, -0.345542, -0.339628, -0.335858, -0.327926, -0.307856, -0.303917, -0.281116, -0.247604, -0.234120, -0.210598, -0.193366, -0.180227, -0.138228
#*# 	  -0.203677, -0.269328, -0.295427, -0.297191, -0.296779, -0.303212, -0.319525, -0.330768, -0.343684, -0.358896, -0.352164, -0.347256, -0.347979, -0.336252, -0.339175, -0.328834, -0.313581, -0.297062, -0.285788, -0.254453, -0.235468, -0.203054, -0.181683, -0.165613, -0.136807
#*# 	  -0.223878, -0.288133, -0.314193, -0.309309, -0.321422, -0.338317, -0.356310, -0.364901, -0.389052, -0.395171, -0.386680, -0.391531, -0.390844, -0.379848, -0.377424, -0.357712, -0.344016, -0.330278, -0.307230, -0.271303, -0.243461, -0.218817, -0.198454, -0.170911, -0.131529
#*# 	  -0.217117, -0.296258, -0.319207, -0.318111, -0.325666, -0.341372, -0.376885, -0.388682, -0.413349, -0.422107, -0.414042, -0.404421, -0.407754, -0.394058, -0.388546, -0.376972, -0.361667, -0.350097, -0.324006, -0.286690, -0.251837, -0.225942, -0.194233, -0.162707, -0.131528
#*# 	  -0.211455, -0.282315, -0.304165, -0.310551, -0.319400, -0.348679, -0.370932, -0.380195, -0.405172, -0.408863, -0.398744, -0.407349, -0.410324, -0.389914, -0.380206, -0.361673, -0.355228, -0.335423, -0.310412, -0.263117, -0.225194, -0.199329, -0.171889, -0.144239, -0.089248
#*# 	  -0.225364, -0.314654, -0.338383, -0.358343, -0.371596, -0.391525, -0.405692, -0.430199, -0.453963, -0.457652, -0.461845, -0.471755, -0.469054, -0.453345, -0.436138, -0.427103, -0.408761, -0.385342, -0.350975, -0.309700, -0.277387, -0.229486, -0.200906, -0.162075, -0.117167
#*# 	  -0.174704, -0.258966, -0.289898, -0.304216, -0.324044, -0.357562, -0.382740, -0.402747, -0.430210, -0.439840, -0.433821, -0.454998, -0.441163, -0.433562, -0.431153, -0.404541, -0.381605, -0.355506, -0.326656, -0.281994, -0.241958, -0.189420, -0.152286, -0.119545, -0.072114
#*# 	  -0.134990, -0.227204, -0.260686, -0.288825, -0.309369, -0.341403, -0.375497, -0.400821, -0.422987, -0.446578, -0.451170, -0.456629, -0.459329, -0.451677, -0.442334, -0.407726, -0.395158, -0.350743, -0.316144, -0.268902, -0.225565, -0.180717, -0.140458, -0.094062, -0.036596
#*# 	  -0.177178, -0.276180, -0.321490, -0.335963, -0.365794, -0.408158, -0.446759, -0.472845, -0.505257, -0.502028, -0.522656, -0.529571, -0.528779, -0.516684, -0.508881, -0.482333, -0.464570, -0.417857, -0.379839, -0.324672, -0.271174, -0.228374, -0.177094, -0.134282, -0.055400
#*# 	  -0.141974, -0.261017, -0.317821, -0.354978, -0.388885, -0.438036, -0.479290, -0.517912, -0.537146, -0.558646, -0.560409, -0.562575, -0.564201, -0.553261, -0.547989, -0.536698, -0.506469, -0.467384, -0.416018, -0.359259, -0.301873, -0.248920, -0.192028, -0.138003, -0.057318
#*# 	  -0.129074, -0.234888, -0.304708, -0.361588, -0.402467, -0.466452, -0.512587, -0.543937, -0.562746, -0.562243, -0.545645, -0.563871, -0.566891, -0.567897, -0.583586, -0.559186, -0.530532, -0.494010, -0.440305, -0.361209, -0.315359, -0.250202, -0.200973, -0.126724, -0.045313
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 329.88
#*# min_y = 15.0
#*# max_y = 334.92
